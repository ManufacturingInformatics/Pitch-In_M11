# beamwritedatatohdf5
Collection of functions used for reading, writing and searching the data generated and collected through BEAM thermal data simulations and runs to a predetermined file structure.

## Created by David Miller, 19/06/2019
## Modified by David Miller, 28/08/2019

## Developed on Python 3.6

## Requirements
This file requires the following packages to be installed:
* numpy [Link](https://www.numpy.org/)
* h5py [Link](http://docs.h5py.org/en/stable/)

## File structure
The data is written to a HDF5 file in a hard-coded structure organised as follows:
* Runs
  * {1 .. inf}
    * Data
      * Laser
        * x
        * y
        * z
        * t
        * T
        * vel
      * Camera
        * Qr
        * Raspberry-Pi
          * pi-camera-data-*
    * Predictions
      * P
      * I
      * r0
      * T
      * Tp

### Group and Dataset Descriptions
The purpose of each group or dataset are as follows:
* Runs        : A collection of incrementally numbered groups, starting from 1, containing the data collected from a production run and the
                    data predicted using this data.
* {1..inf}    : The data collected in a specific production run and the predictions made using that data and known material parameters.
                    The number indicates the order in which the run was created in the file.
* Data        : The data collected during the specific production run. Designed to contain the thermal camera footage and the data contained
                    in the XML log file for the motor controlling the laser position. To be stored, the files need to be processed by the functions
                    readH264 and readXMLData functions.
* Laser       : Collection of datasets for the data contained in the XML log file.
* x           : Laser motor position on the x-axis relative to a preset origin point. Units are mm
* y           : Laser motor position on the y-axis relative to a preset origin point. Units are mm
* z           : Laser motor position on the z-axis relative to a preset origin point. Units are mm
* T           : Laser motor torque. Units are N/m
* vel         : Laser motor velocity. Units are mm/s
* t           : Time at which the values are sampled relative to start of recording. Applies to all laser datasets as they are all sampled at the same rate.
* Camera      : Group containing a dataset for the thermal camera data. It's a group to allow other thermal camera data to be stored
* Qr          : The footage captured by the thermal camera as processed by the readH264 function. It is named as the camera captures radiative heat.
                    The image resolution is known to be 128x128
* Raspberry-Pi: Group containing the data recorded by Raspberry Pi thermal cameras.
* pi-camera-data-* : Data recorded on a Raspberry Pi thermal camera. Not necessarily called pi-camera-data-* as custom names are allowed.
* Predictions : Collection of datasets generated by the thermal model representing predicted laser paramters such as laser power and material behaviour
                    such as surface temperature. It's a group to allow other results to be added.
* P           : Predicted laser power profile. Units are Watts
* I           : Predicted laser power density. Units are Watts/m2
* r0          : Predicted laser radius. Units are m
* T           : Predicted surface temperature. Units are Kelvin
* Tp          : Predicted peak surface temperature. Units are Kelvin

### Attributes
Attributes are additional descriptive pieces of data attached to an object in the HDF5 file. These act as metadata for the data stored and provides context or other helpful information. 

More information about H5py attributes and how to access them can be found [here](http://docs.h5py.org/en/stable/high/attr.html)

Basic example:

**mat_used = fun_group.attrs.get("Material",default='')**

The attributes used with specific objects are as follows:
* Used with: {1..inf}
 * Material : String indicating which material was used in this particular run. The default material assigned is SS-316L which     indicates Stainless Steel 316L is used.
 * Date-Time : ISO format date time stamp for when the run was last modified.
* Used with: All datasets
 * size : Size of the data. (rows,height,depth,..). Also obtainable by looking at the size of the dataset (e.g. dset.size)
 * dtype : String version of data type. Also obtainable by looking at the dtype of the dataset (e.g. dset.dtype)
 * description : A brief description of the variable
 * unitType : Description of the units of the variable. E.g. Watts, Metres etc.
* used with: x,y,z,t,T,vel
 * count : Number of data points recorded according to the header information in the XML log file.
 * interval : Interval between samples in XML log file.
 * Log-Date-Time : ISO format date time stamp when the data in the XML file was recorded.

## Functions
The module contains the following functions:
* readH264        : Read in thermal camera data encoded as a H264 file. Assumes 128x128 image resolution.
* readXMLData     : Parse the first data frame in the laser motor XML log file and return the different datasets and header information.
* readXMLDataDict : Parse the first data frame in the laser motor XML log file and return the different datasets in a dictionary.
* createRunGroup  : Create a new run under the Runs super-group. The new name is the previous name plus one. All the sub-groups are generated as well.
                        It returns the newly created run object. Returns False if failed.
* getRun          : Get the specified run from the file object. Returns None if it doesn't exist or the file has not been initializes with the Runs group.
                        If the requested run is -1 then all runs are returned in a list.
* getLatestRun    : Retrieve the latest run in the file. Uses getNumRuns to retrieve the name. Returns the group object if it exists and None if it doesn't.
* addQr           : Add the supplied thermal camera matrix to either the latest run or create a new run to store the data. Returns True and the dataset object
                        if successful or False,None if it failed.
* addXML          : Parses the data structure returned by the the readXMLData function and adds it to either the latest run or created a new run. Returns
                        True and the modified or created run group or False and None if it failed.
* addRaspPiCamera : Add the supplied data collected from Raspberry Pi cameras to eitehr the latest run or create a new run to store the data. The data can be supplied as a single dataset, list of datasets or dictionary. 
* getAllDatasets  : Retrieves all the datasets from the given h5py object. This can either be the entire tree or a specific run group. Returns the found
                        datasets in a list.
* getDatasets     : Retrieve the specified datasets from the given h5py object. This can either be the entire tree or a specific run group. Returns the found
                        datasets in a list.
* getDatasetsFrom : Wrapper function for getDatasets. Retrieves the specified datasets from the specified run. Returns the found datasets in a list.
* updateData      : Update the specified datasets with the supplied arrays in the latest run or create a new run. The user can also specify a run to update
                        with the run_num keyword. Returns True and the newly created or modified run group or False and None if it failed.
* getSetsFromDirList : Iterate through HDF5 files in the given directory path and collect the datasets stored in each file into a list.
* getSetsFromDirDict : Iterate through HDF5 files in the given directory path and collect the datasets stored in each file into a dictionary where each key is the name of the dataset.
* getNumRuns      : Get and return the number of runs in the file.
* printFileStructure : Print the structure of the given h5py object to screen including attributes. The different depths of the object in the tree are
                           representated by different levels of indentation.
* initialize      : Creates a new h5py file at the supplied location and creates the high level groups in the file. At the moment the only high level group
                        created in the file in Runs. The purpose of the function is to make it easier to manage. Returns the h5py file object.
* 

## NOTES
* It is the responsibility of the user to close the file when they're finished with it. Call close method the file object.
* If the user wishes to use the context manager for the file object, they need to create the Runs group otherwise most of the functions will fail.
* If the file is run in IDLE a demo is executed (REQUIRES PATHS TO BE MODIFIED FOR PERSONAL TESTING):
  * Creates and initializes a HDF5 file.
  * Creates a randon number (1,10) of groups in the file.
  * Prints the file structure to show that it has been modified.
  * Updates the latest run by:
    * Assigning random data to Qr dataset
    * Reading in in the specified XML data file and adds it to the file
  * Retrieves all the added data sets and prints the names, shape and data types
  * Prints the attributes of the x data set in Laser group.
  * Gets the latest run and prints the name and structure of it.
  * Gets all the runs in the file and prints the date-time stamps of their creation.
